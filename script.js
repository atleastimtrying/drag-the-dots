// Generated by CoffeeScript 1.6.2
(function() {
  var App, Game, Layouts, Screens, Storage, Timer, UI,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  Storage = (function() {
    function Storage(app) {
      this.app = app;
      this.addScore = __bind(this.addScore, this);
      $('body').bind('addScore', this.addScore);
      $('body').bind('getScores', this.getScores);
      $('body').bind('clearScores', this.clearScores);
      $('body').bind('getName', this.getName);
      $('body').bind('setName', this.setName);
    }

    Storage.prototype.sortByScore = function(a, b) {
      var response;
      response = 0;
      if (a.score < b.score) {
        response = -1;
      }
      if (a.score > b.score) {
        response = 1;
      }
      return response;
    };

    Storage.prototype.addScore = function(event, data) {
      var group, grouped, level, scores;
      scores = JSON.parse(window.localStorage.getItem('scores'));
      if (!scores) {
        scores = [];
      }
      scores.push(data);
      grouped = _.groupBy(scores, function(obj) {
        return obj.level;
      });
      scores = [];
      for (level in grouped) {
        group = grouped[level];
        group.sort(this.sortByScore);
        if (group.length > 10) {
          group.length = 10;
        }
        scores = scores.concat(group);
      }
      return localStorage.setItem('scores', JSON.stringify(scores));
    };

    Storage.prototype.getScores = function(event, fn) {
      return fn(JSON.parse(window.localStorage.getItem('scores')));
    };

    Storage.prototype.clearScores = function(event) {
      localStorage.setItem('scores', JSON.stringify([]));
      return $('body').trigger('show', 'scores');
    };

    Storage.prototype.getName = function(event, fn) {
      return fn(localStorage.getItem('name'));
    };

    Storage.prototype.setName = function(event, name) {
      return localStorage.setItem('name', name);
    };

    return Storage;

  })();

  Timer = (function() {
    function Timer(app) {
      this.app = app;
      this.start = __bind(this.start, this);
      this.stop = __bind(this.stop, this);
      this.tick = __bind(this.tick, this);
      this.going = false;
      this.count = 0;
    }

    Timer.prototype.tick = function() {
      $('.timer').html(this.count / 10);
      this.count += 1;
      if (this.going) {
        return window.setTimeout(this.tick, 100);
      }
    };

    Timer.prototype.stop = function() {
      this.going = false;
      this.app.score = this.count / 10;
      return $('body').trigger('show', 'score');
    };

    Timer.prototype.start = function() {
      this.count = 0;
      this.going = true;
      return this.tick();
    };

    return Timer;

  })();

  Layouts = {
    random: function() {
      var range,
        _this = this;
      range = $('.dot').width() / 2;
      return $('.dot').each(function(index, dot) {
        $(dot).css({
          top: Math.ceil(Math.random() * ($('#container').height() - (range * 2))),
          left: Math.ceil(Math.random() * ($('#container').width() - (range * 2))),
          background: "hsl(" + (index * 50) + ",50%, 50%)"
        });
        if (index === 0) {
          return $(dot).css({
            background: "hsl(50,50%, 50%)"
          });
        }
      });
    },
    grid: function() {
      var center, count, edge, i, layouts, x, y, _i, _ref,
        _this = this;
      count = $('.dot').length;
      layouts = [];
      edge = Math.floor(Math.sqrt(count)) - 1;
      x = 0;
      y = 0;
      for (i = _i = 0, _ref = count - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
        layouts.push({
          x: x,
          y: y
        });
        if (x < edge) {
          x += 1;
        } else {
          x = 0;
          y += 1;
        }
      }
      layouts = layouts.sort(function() {
        return 0.5 - Math.random();
      });
      center = {
        x: ($('#container').width() / 2) + 105,
        y: ($('#container').height() / 2) + 105
      };
      return $('.dot').each(function(index, dot) {
        var coords;
        coords = layouts[index];
        console.log(coords);
        $(dot).css({
          left: center.x - coords.x * 70,
          top: center.y - coords.y * 70,
          background: "hsl(" + (index * 50) + ",50%, 50%)"
        });
        if (index === 0) {
          return $(dot).css({
            background: "hsl(50,50%, 50%)"
          });
        }
      });
    }
  };

  Game = (function() {
    function Game(app) {
      this.app = app;
      this.hitDetection = __bind(this.hitDetection, this);
      this.startGame = __bind(this.startGame, this);
      $('body').on('startGame', this.startGame);
      this.count = 10;
      this.timer = new Timer(this.app);
      this.range = 30;
    }

    Game.prototype.startGame = function(event, options) {
      if (options == null) {
        options = {
          count: this.count,
          layout: this.layout
        };
      }
      if (options.count) {
        this.count = options.count;
      }
      if (options.layout) {
        this.layout = options.layout;
      }
      $('#score, #scores, #start, #enterName').hide();
      $('#container, .timer').show();
      $('#container .dot').remove();
      this.addDots();
      this.makeDotsDraggable();
      this.layoutDots();
      return this.timer.start();
    };

    Game.prototype.collide = function(item1, item2) {
      return item1.top < item2.top + this.range && item1.top > item2.top - this.range && item1.left < item2.left + this.range && item1.left > item2.left - this.range;
    };

    Game.prototype.hitDetection = function(event) {
      var dot, dot_value, dotid, newValue, target;
      dot = $(event.target);
      dotid = dot.attr('data-id');
      dot_value = dot.attr('data-value');
      target = $("[data-value=" + dot_value + "]").not("[data-id=" + dotid + "]");
      if (target[0] && this.collide(dot.offset(), target.offset())) {
        newValue = parseInt(dot_value) + 1;
        target.attr('data-value', newValue).html(newValue).css({
          background: "hsl(" + (newValue * 50) + ",50%, 50%)"
        });
        dot.remove();
        if (dot_value === ("" + this.count)) {
          return this.timer.stop();
        }
      }
    };

    Game.prototype.addDots = function() {
      var i, oldvalue, value, _i, _ref;
      oldvalue = 1;
      value = 1;
      for (i = _i = 0, _ref = this.count - 1; 0 <= _ref ? _i <= _ref : _i >= _ref; i = 0 <= _ref ? ++_i : --_i) {
        $('#container').append("<div class='dot' data-value='" + value + "' data-id='" + i + "' >" + value + "</div>");
        oldvalue = value;
        value = oldvalue + 1;
      }
      return $('#container').prepend('<div class="dot" data-value="1" data-id="1000" >1</div>');
    };

    Game.prototype.makeDotsDraggable = function() {
      return $('.dot').draggable({
        stop: this.hitDetection,
        containment: "#container",
        scroll: false
      });
    };

    Game.prototype.layoutDots = function() {
      if (this.layout === 'random') {
        Layouts.random();
      }
      if (this.layout === 'grid') {
        return Layouts.grid();
      }
    };

    return Game;

  })();

  $(function() {
    return window.app = new App();
  });

  UI = (function() {
    function UI() {
      $('body').trigger('getName', function(name) {
        if (name) {
          $('.name').html(name);
          return $('body').trigger('show', 'start');
        } else {
          return $('body').trigger('show', 'name');
        }
      });
      this.bindClicks();
    }

    UI.prototype.bindClicks = function() {
      $('.not-name').click(function() {
        $('body').trigger('setName', '');
        $('body').trigger('show', 'name');
        return false;
      });
      $('.startRandom').click(function() {
        $('body').trigger('startGame', {
          count: 10,
          layout: 'random'
        });
        return false;
      });
      $('.startGrid').click(function() {
        $('body').trigger('startGame', {
          count: 8,
          layout: 'grid'
        });
        return false;
      });
      $('.again').click(function() {
        $('body').trigger('startGame');
        return false;
      });
      $('.showScores').click(function() {
        $('body').trigger('show', 'scores');
        return false;
      });
      $('.showStart').click(function() {
        $('body').trigger('show', 'start');
        return false;
      });
      $('.clearScores').click(function() {
        $('body').trigger('clearScores');
        return false;
      });
      return $('#enterName button').on('click', function() {
        $('body').trigger('setName', $('#enterName input').val());
        $('.name').html($('#enterName input').val());
        $('body').trigger('show', 'start');
        return false;
      });
    };

    return UI;

  })();

  Screens = (function() {
    function Screens(app) {
      var _this = this;
      this.app = app;
      $('body').on('show', function(event, label) {
        return _this[label]();
      });
    }

    Screens.prototype.name = function() {
      $('#score, #scores, #start, .timer, #container').hide();
      return $('#enterName').show();
    };

    Screens.prototype.score = function() {
      $('#container, #scores, #start, .timer, #enterName').hide();
      $('#score').show();
      $('#scoreMessage').html("" + this.app.score + " seconds!");
      return $('body').trigger('getName', function(name) {
        return $('body').trigger('addScore', {
          level: this.app.game.count,
          score: this.app.score,
          name: name
        });
      });
    };

    Screens.prototype.start = function() {
      $('#container, #scores, #score, .timer, #enterName').hide();
      return $('#start').show();
    };

    Screens.prototype.scores = function() {
      $('#container, #start, #score, .timer, #enterName').hide();
      $('#scores').show();
      return $('body').trigger('getScores', function(scores) {
        var html;
        html = {
          'score10': '',
          'score8': ''
        };
        $(scores).each(function(index, score) {
          return html["score" + score.level] += "<tr><td>" + score.name + "</td><td>" + score.score + "</td></tr>";
        });
        $('#scores table.table10 tbody').html(html['score10']);
        return $('#scores table.table8 tbody').html(html['score8']);
      });
    };

    return Screens;

  })();

  App = (function() {
    function App() {
      this.score = 0;
      this.storage = new Storage(this);
      this.ui = new UI(this);
      this.screens = new Screens(this);
      this.game = new Game(this);
      $('body').trigger('getName', function(name) {
        if (name) {
          return $('body').trigger('show', 'start');
        } else {
          return $('body').trigger('show', 'name');
        }
      });
    }

    return App;

  })();

}).call(this);
